#!/usr/bin/env bash

EXITCODE_SUCCESS=0
EXITCODE_FAILURE=255

PSQL_BIN=$( which psql )

APP_PATH=$( dirname $0 )/..
DB_PATH=$( readlink --canonicalize $APP_PATH )/db
DATA_PATH=$( readlink --canonicalize $APP_PATH )/data/variable
SCRIPT_PATH=$APP_PATH/scripts
HELPERS_PATH=$SCRIPT_PATH/helpers

source $HELPERS_PATH/string

NUM_RECORDS=$1
HOST=$2

USERNAME=db-scaling-test
DB=db-scaling-test-variable

if [ -z $NUM_RECORDS ]; then
  echo "usage: $( basename $0 ) <NUMBER OF RECORDS> [DB HOST]"

  exit $EXITCODE_FAILURE

fi

if [ -z $HOST ]; then
  HOST=localhost
fi

mkdir --parents --verbose $DATA_PATH


for ((IDX=0; IDX < NUM_RECORDS; IDX++)); do

  AUTHOR="$( generate_random_string 64 )"
  EMAIL="$AUTHOR@$( generate_random_string 24 ).com"
  PASSWORD="$( generate_random_string 48 )"

  POST="$( generate_random_string 64 )"
  POST_HEADER="$( generate_random_string 64 )"
  POST_CONTENT="$( generate_random_string 65535 )"
  POST_STYLE="$( generate_random_string 32767 )"

  TOPIC="$( generate_random_string 64 )"
  TOPIC_CONTENT="$( generate_random_string 32 )"

  DATA_LEN=$( expr length "$PASSWORD$EMAIL$POST_CONTENT$POST_HEADER$POST_STYLE$TOPIC_CONTENT" )

  echo $AUTHOR >> $DATA_PATH/authors
  echo $POST >> $DATA_PATH/posts
  echo $TOPIC >> $DATA_PATH/topics

  QUERY="BEGIN;"

  # INSERT BEGIN TIMESTAMP INTO STATISTICS.
  QUERY+="INSERT INTO statistics.actions(operation, step, timestamp, size) \
    VALUES ('create', 'begin', current_timestamp, $DATA_LEN);"


  # INSERT INTO AUTHORS.
  QUERY+="INSERT INTO author.handle(value, readable, writeable, created, updated) \
    VALUES('$AUTHOR', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO author.active(value, handle, readable, writeable, created, updated) \
    VALUES(true, '$AUTHOR', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO author.email(value, handle, readable, writeable, created, updated) \
    VALUES('$EMAIL', '$AUTHOR', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO author.password(value, handle, readable, writeable, created, updated) \
    VALUES('$PASSWORD', '$AUTHOR', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO author.searchable(value, handle, readable, writeable, created, updated) \
    VALUES(true, '$AUTHOR', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO author.commenting(value, handle, readable, writeable, created, updated) \
    VALUES(true, '$AUTHOR', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"


  # INSERT INTO POSTS.
  QUERY+="INSERT INTO post.handle(value, readable, writeable, created, updated) \
    VALUES('$POST', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO post.author(value, handle, readable, writeable, created, updated) \
    VALUES('$AUTHOR', '$POST', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO post.active(value, handle, readable, writeable, created, updated) \
    VALUES(true, '$POST', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO post.header(value, handle, readable, writeable, created, updated) \
    VALUES('$POST_HEADER', '$POST', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO post.content(value, handle, readable, writeable, created, updated) \
    VALUES('$POST_CONTENT', '$POST', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO post.style(value, handle, readable, writeable, created, updated) \
    VALUES('$POST_STYLE', '$POST', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO post.searchable(value, handle, readable, writeable, created, updated) \
    VALUES(true, '$POST', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO post.commenting(value, handle, readable, writeable, created, updated) \
    VALUES(true, '$POST', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"


  # INSERT INTO TOPICS.
  QUERY+="INSERT INTO topic.handle(value, readable, writeable, created, updated) \
    VALUES('$TOPIC', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO topic.post(value, handle, readable, writeable, created, updated) \
    VALUES('$POST', '$TOPIC', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO topic.content(value, handle, readable, writeable, created, updated) \
    VALUES('$TOPIC_CONTENT', '$TOPIC', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO topic.active(value, handle, readable, writeable, created, updated) \
    VALUES(true, '$TOPIC', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"
  QUERY+="INSERT INTO topic.searchable(value, handle, readable, writeable, created, updated) \
    VALUES(true, '$TOPIC', true, true, (SELECT now()::TIMESTAMP), (SELECT now()::TIMESTAMP));"


  # INSERT END TIMESTAMP INTO STATISTICS.
  QUERY+="INSERT INTO statistics.actions(operation, step, timestamp, size) \
    VALUES ('create', 'end', current_timestamp, $DATA_LEN);"

  QUERY+="COMMIT;"


  $PSQL_BIN --host=$HOST --quiet --command="$QUERY" $DB $USERNAME

done

exit $EXITCODE_SUCCESS
