#!/usr/bin/env bash

EXITCODE_SUCCESS=0
EXITCODE_FAILURE=255

PSQL_BIN=$( which psql )

APP_PATH=$( readlink --canonicalize $( dirname $0 )/.. )
DB_PATH=$APP_PATH/db
DATA_PATH=$APP_PATH/data/variable
SCRIPT_PATH=$APP_PATH/scripts
HELPERS_PATH=$SCRIPT_PATH/helpers

source $HELPERS_PATH/string

USERNAME=db-scaling-test
DB=db-scaling-test-variable

HOST=$1
NUM_RECORDS=$2

if [ -z $NUM_RECORDS ]; then
  QUERY="SELECT COUNT(handle) from authors;"
  REGEX="^[[:space:]]{1,}[[:digit:]]{1,}"

  # default to querying the database for the number of records.
  NUM_RECORDS=$( $PSQL_BIN $DB --username $USERNAME -c "$QUERY" | grep -P $REGEX | tr -d " " )

fi

if [ -z $HOST ]; then
  # default to localhost if none is given.
  HOST=localhost
fi


for ((IDX=0; IDX < NUM_RECORDS; IDX++)); do

  AUTHOR=$( get_random_line_from_file $DATA_PATH/authors )
  POST=$( get_random_line_from_file $DATA_PATH/posts )
  TOPIC=$( get_random_line_from_file $DATA_PATH/topics )

  EMAIL="$AUTHOR@$( generate_random_string 24 ).com"
  PASSWORD="$( generate_random_string 48 )"
  POST_HEADER="$( generate_random_string 64 )"
  POST_STYLE="$( generate_random_string 32767 )"
  POST_CONTENT="$( generate_random_string 65535 )"

  DATA_LEN=$( expr length "$PASSWORD$EMAIL$POST_CONTENT$POST_HEADER$POST_STYLE$TOPIC_CONTENT" )

  QUERY="BEGIN;"

  # INSERT BEGIN TIMESTAMP INTO STATISTICS.
  QUERY+="INSERT INTO statistics.actions(operation, step, timestamp, size) \
    VALUES ('update', 'begin', current_timestamp, $DATA_LEN);"

  QUERY+="UPDATE author.password SET value='$PASSWORD' WHERE handle='$AUTHOR';"
  QUERY+="UPDATE author.email SET value='$EMAIL' WHERE handle='$AUTHOR';"

  QUERY+="UPDATE post.content SET value='$POST_CONTENT' WHERE handle='$POST';"
  QUERY+="UPDATE post.header SET value='$POST_HEADER' WHERE handle='$POST';"
  QUERY+="UPDATE post.style SET value='$POST_STYLE' WHERE handle='$POST';"

  QUERY+="UPDATE topic.content SET value='$TOPIC_CONTENT' WHERE handle='$TOPIC';"

  # INSERT END TIMESTAMP INTO STATISTICS.
  QUERY+="INSERT INTO statistics.actions(operation, step, timestamp, size) \
    VALUES ('update', 'end', current_timestamp, $DATA_LEN);"

  QUERY+="COMMIT;"


  $PSQL_BIN --host=$HOST --quiet --command="$QUERY" $DB $USERNAME

done

exit $EXITCODE_SUCCESS
